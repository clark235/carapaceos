name: CarapaceOS CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€ Fast validation: unit tests (no QEMU needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps (if any)
        run: '[ -f package-lock.json ] && npm ci || true'

      - name: Verify package exports
        run: node -e "import('./index.js').then(m => { console.log('exports OK:', Object.keys(m)); })"

      - name: Check CLI entrypoint
        run: node lib/cli.js --help || true  # cli may exit 0 or 1 for --help

  # â”€â”€ Image build: compile the QEMU disk image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image:
    name: Build VM Image
    runs-on: ubuntu-latest
    outputs:
      image-artifact: carapaceos-qcow2
    steps:
      - uses: actions/checkout@v4

      - name: Install QEMU + build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            qemu-system-x86 qemu-utils \
            cloud-image-utils genisoimage \
            wget curl

      - name: Cache Alpine ISO
        uses: actions/cache@v4
        with:
          path: vm-image/*.iso
          key: alpine-iso-3.21.3-x86_64

      - name: Build CarapaceOS QEMU image
        run: |
          cd vm-image
          bash build-image.sh
        timeout-minutes: 20

      - name: Verify image exists and is valid
        run: |
          ls -lh vm-image/carapaceos.qcow2
          qemu-img info vm-image/carapaceos.qcow2

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: carapaceos-qcow2
          path: vm-image/carapaceos.qcow2
          retention-days: 1

  # â”€â”€ Integration test: boot VM, run validation via runner API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  integration-test:
    name: Integration Test (QEMU Boot)
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install QEMU + SSH tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            qemu-system-x86 qemu-utils \
            openssh-client genisoimage \
            cloud-image-utils

      - name: Enable KVM (if available)
        run: |
          if [ -e /dev/kvm ]; then
            sudo chmod 666 /dev/kvm
            echo "KVM_AVAILABLE=true" >> $GITHUB_ENV
            echo "KVM available âœ…"
          else
            echo "KVM_AVAILABLE=false" >> $GITHUB_ENV
            echo "KVM not available, using TCG (slower)"
          fi

      - name: Download VM image
        uses: actions/download-artifact@v4
        with:
          name: carapaceos-qcow2
          path: vm-image/

      - name: Run integration test
        run: |
          node lib/test-runner.js
        env:
          CARAPACE_ENABLE_KVM: ${{ env.KVM_AVAILABLE }}
        timeout-minutes: 10

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: /tmp/carapace-*.log
          retention-days: 3

  # â”€â”€ npm dry-run: verify package would publish cleanly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  npm-dry-run:
    name: npm Publish Dry Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Run prepublishOnly check
        run: npm run prepublishOnly

      - name: npm pack (dry run)
        run: |
          npm pack --dry-run 2>&1 | tee pack-output.txt
          # Fail if the pack would be unexpectedly large (>10MB without qcow2)
          SIZE=$(npm pack --dry-run 2>&1 | grep "package size" | grep -oP '[\d.]+ [kMG]B' | head -1)
          echo "Package size: $SIZE"

  # â”€â”€ Summary badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, build-image, integration-test, npm-dry-run]
    if: always()
    steps:
      - name: Write job summary
        run: |
          echo "## ðŸ¦ž CarapaceOS CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Image | ${{ needs.build-image.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test | ${{ needs.integration-test.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm Dry Run | ${{ needs.npm-dry-run.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
