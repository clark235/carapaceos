#!/usr/bin/env node
/**
 * CarapaceOS OpenClaw Agent Demo
 * Demonstrates an AI agent running inside CarapaceOS performing real tasks
 */

const fs = require('fs');
const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

class CarapaceAgent {
    constructor(name = 'CarapaceDemo') {
        this.name = name;
        this.workspace = '/agent/workspace';
        this.logFile = `${this.workspace}/agent-log.txt`;
    }

    log(message) {
        const timestamp = new Date().toISOString();
        const logEntry = `[${timestamp}] ${this.name}: ${message}\n`;
        console.log(`ü¶û ${message}`);
        
        // Append to log file
        try {
            fs.appendFileSync(this.logFile, logEntry);
        } catch (err) {
            console.error('Failed to write to log file:', err.message);
        }
    }

    async runCommand(command) {
        this.log(`Executing: ${command}`);
        try {
            const { stdout, stderr } = await execAsync(command);
            if (stdout.trim()) this.log(`Output: ${stdout.trim()}`);
            if (stderr.trim()) this.log(`Warning: ${stderr.trim()}`);
            return stdout;
        } catch (error) {
            this.log(`Command failed: ${error.message}`);
            throw error;
        }
    }

    async analyzeSystem() {
        this.log("Analyzing CarapaceOS environment...");
        
        const checks = [
            { name: 'Node.js version', cmd: 'node --version' },
            { name: 'Git version', cmd: 'git --version' },
            { name: 'Available disk space', cmd: 'df -h /' },
            { name: 'Memory usage', cmd: 'cat /proc/meminfo | head -3' },
            { name: 'Current user', cmd: 'whoami' },
            { name: 'Working directory', cmd: 'pwd' }
        ];

        const results = {};
        for (const check of checks) {
            try {
                const output = await this.runCommand(check.cmd);
                results[check.name] = output.trim();
            } catch (err) {
                results[check.name] = `ERROR: ${err.message}`;
            }
        }

        return results;
    }

    async createProject() {
        this.log("Creating a sample project...");
        
        const projectDir = `${this.workspace}/sample-project`;
        
        // Create project structure
        await this.runCommand(`mkdir -p ${projectDir}/src ${projectDir}/tests`);
        
        // Create package.json
        const packageJson = {
            name: "carapace-demo-project",
            version: "1.0.0",
            description: "A project created by an agent running in CarapaceOS",
            main: "src/index.js",
            scripts: {
                start: "node src/index.js",
                test: "echo 'Tests would run here'"
            },
            author: "CarapaceOS Agent",
            license: "MIT"
        };
        
        fs.writeFileSync(`${projectDir}/package.json`, JSON.stringify(packageJson, null, 2));
        
        // Create main application file
        const mainFile = `// Generated by CarapaceOS Agent at ${new Date().toISOString()}

console.log('ü¶û Hello from CarapaceOS!');
console.log('This project was created by an AI agent running in a minimal container.');

const stats = {
    nodeVersion: process.version,
    platform: process.platform,
    arch: process.arch,
    memoryUsage: process.memoryUsage(),
    uptime: process.uptime()
};

console.log('System stats:', JSON.stringify(stats, null, 2));
`;
        
        fs.writeFileSync(`${projectDir}/src/index.js`, mainFile);
        
        // Create README
        const readme = `# CarapaceOS Demo Project

This project was auto-generated by an AI agent running inside CarapaceOS.

## About CarapaceOS

CarapaceOS is a minimal container image optimized for AI agents. It includes:
- Node.js runtime
- Git for version control
- Basic shell tools
- Nothing unnecessary

## Running this project

\`\`\`bash
cd sample-project
node src/index.js
\`\`\`

Generated at: ${new Date().toISOString()}
`;
        
        fs.writeFileSync(`${projectDir}/README.md`, readme);
        
        // Initialize git repo
        await this.runCommand(`cd ${projectDir} && git init`);
        await this.runCommand(`cd ${projectDir} && git config user.email "agent@carapaceos.local"`);
        await this.runCommand(`cd ${projectDir} && git config user.name "CarapaceOS Agent"`);
        await this.runCommand(`cd ${projectDir} && git add .`);
        await this.runCommand(`cd ${projectDir} && git commit -m "Initial commit by CarapaceOS agent"`);
        
        this.log(`Project created at ${projectDir}`);
        
        // Test the project
        const output = await this.runCommand(`cd ${projectDir} && node src/index.js`);
        this.log("Project test output received");
        
        return projectDir;
    }

    async generateReport() {
        this.log("Generating performance report...");
        
        const report = {
            agent: this.name,
            timestamp: new Date().toISOString(),
            environment: 'CarapaceOS',
            system: {},
            tasks: {
                completed: ['system analysis', 'project creation', 'git operations'],
                duration: 'under 30 seconds',
                status: 'success'
            }
        };

        try {
            const systemInfo = await this.analyzeSystem();
            report.system = systemInfo;
        } catch (err) {
            report.system.error = err.message;
        }

        const reportPath = `${this.workspace}/agent-report.json`;
        fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
        
        this.log(`Report saved to ${reportPath}`);
        return report;
    }

    async run() {
        try {
            this.log(`Starting agent demo in CarapaceOS...`);
            
            // Analyze the system
            await this.analyzeSystem();
            
            // Create a sample project
            await this.createProject();
            
            // Generate report
            const report = await this.generateReport();
            
            this.log("Demo completed successfully!");
            this.log(`Log file available at: ${this.logFile}`);
            
            return report;
            
        } catch (error) {
            this.log(`Agent demo failed: ${error.message}`);
            throw error;
        }
    }
}

// Run the demo if this script is executed directly
if (require.main === module) {
    const agent = new CarapaceAgent();
    agent.run()
        .then(report => {
            console.log('\nüéâ Agent demo completed successfully!');
            console.log('Final report summary:');
            console.log(`- Tasks completed: ${report.tasks.completed.length}`);
            console.log(`- Duration: ${report.tasks.duration}`);
            console.log(`- Status: ${report.tasks.status}`);
        })
        .catch(error => {
            console.error('\n‚ùå Agent demo failed:', error.message);
            process.exit(1);
        });
}

module.exports = CarapaceAgent;